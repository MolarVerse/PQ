#!/bin/bash

message=$(cat .git/COMMIT_EDITMSG)
lowercase_message=${message,,}

# Check for patterns and handle errors
matched=false

# Features
if [[ "$lowercase_message" =~ ^feat(\(.+\))?: ]]; then
  matched=true
  group="Feature"
elif [[ "$lowercase_message" =~ ^feature(\(.+\))?: ]]; then
  matched=true
  group="Feature"
fi

# Bug Fixes
if [[ "$lowercase_message" =~ ^fix(\(.+\))?: ]]; then
  matched=true
  group="Fix"
elif [[ "$lowercase_message" =~ ^bugfix(\(.+\))?: ]]; then
  matched=true
  group="Fix"
fi

# Documentation
if [[ "$lowercase_message" =~ ^docs(\(.+\))?: ]]; then
  matched=true
  group="Docs"
elif [[ "$lowercase_message" =~ ^doc(\(.+\))?: ]]; then
  matched=true
  group="Docs"
elif [[ "$lowercase_message" =~ ^documentation(\(.+\))?: ]]; then
  matched=true
  group="Docs"
fi

# Style
if [[ "$lowercase_message" =~ ^style(\(.+\))?: ]]; then
  matched=true
  group="Style"
elif [[ "$lowercase_message" =~ ^format(\(.+\))?: ]]; then
  matched=true
  group="Style"
fi

# Refactor
if [[ "$lowercase_message" =~ ^refactor(\(.+\))?: ]]; then
  matched=true
  group="Refactor"
elif [[ "$lowercase_message" =~ ^ref(\(.+\))?: ]]; then
  matched=true
  group="Refactor"
fi

# Performance
if [[ "$lowercase_message" =~ ^perf(\(.+\))?: ]]; then
  matched=true
  group="Performance"
elif [[ "$lowercase_message" =~ ^performance(\(.+\))?: ]]; then
  matched=true
  group="Performance"
fi

# Test
if [[ "$lowercase_message" =~ ^test(\(.+\))?: ]]; then
  matched=true
  group="Test"
elif [[ "$lowercase_message" =~ ^tests(\(.+\))?: ]]; then
  matched=true
  group="Test"
elif [[ "$lowercase_message" =~ ^testing(\(.+\))?: ]]; then
  matched=true
  group="Test"
fi

# Internal
if [[ "$lowercase_message" =~ ^internal(\(.+\))?: ]]; then
  matched=true
  group="Internal"
fi

# Chore
if [[ "$lowercase_message" =~ ^chore(\(.+\))?: ]]; then
  matched=true
  group="Chore"
fi

# Merge
if [[ "$lowercase_message" =~ ^merge(\(.+\))?: ]]; then
  matched=true
  group="Merge"
fi

# Reverts
if [[ "$lowercase_message" =~ ^revert(\(.+\))?: ]]; then
  matched=true
  group="Revert"
fi

# Build
if [[ "$lowercase_message" =~ ^build(\(.+\))?: ]]; then
  matched=true
  group="Build"
fi

# Breaking
if [[ "$lowercase_message" =~ ^breaking(\(.+\))?: ]]; then
  matched=true
  group="Breaking"
fi

# Examples
if [[ "$lowercase_message" =~ ^example(\(.+\))?: ]]; then
  matched=true
  group="Example"
elif [[ "$lowercase_message" =~ ^examples(\(.+\))?: ]]; then
  matched=true
  group="Example"
fi

# Dependency Updates (informational)
if [[ "$lowercase_message" =~ ^deps(\(.+\))?: ]]; then
  matched=true
  group="Dependency"
elif [[ "$lowercase_message" =~ ^dependency(\(.+\))?: ]]; then
  matched=true
  group="Dependency"
fi

# Workflow
if [[ "$lowercase_message" =~ ^flow(\(.+\))?: ]]; then
  matched=true
  group="Workflow"
elif [[ "$lowercase_message" =~ ^workflow(\(.+\))?: ]]; then
  matched=true
  group="Workflow"
fi

# CI
if [[ "$lowercase_message" =~ ^ci(\(.+\))?: ]]; then
  matched=true
  group="CI"
fi

# CMake
if [[ "$lowercase_message" =~ ^cmake(\(.+\))?: ]]; then
  matched=true
  group="cmake"
fi

# Administrative
if [[ "$lowercase_message" =~ ^admin(\(.+\))?: ]]; then
  matched=true
  group="Administrative"
elif [[ "$lowercase_message" =~ ^administrative(\(.+\))?: ]]; then
  matched=true
  group="Administrative"
fi

# ... (similar checks for other patterns in the list)

# No match found
if ! $matched; then
  echo "Error: Commit message header '$message' does not match any defined pattern!\n"

  #list me all possible patterns per group in a nice formatted output
  echo "Possible patterns are:"
  echo "  - Group:          Pattern(s)"
  echo "  - --------------------------------------------"
  echo "  - Feature:        feature:, feat:"
  echo "  - Fix:            bugfix:, fix:"
  echo "  - Docs:           documentation:, docs:, doc:"
  echo "  - Style:          style:, format:"
  echo "  - Refactor:       refactor:, ref:"
  echo "  - Performance:    performance:, perf:"
  echo "  - Test:           test:, tests:, testing:"
  echo "  - Internal:       internal:"
  echo "  - Chore:          chore:"
  echo "  - Merge:          merge:"
  echo "  - Revert:         revert:"
  echo "  - Build:          build:"
  echo "  - Breaking:       breaking:"
  echo "  - Example:        example:, examples:"
  echo "  - Dependency:     deps:, dependency:"
  echo "  - Workflow:       workflow:, flow:"
  echo "  - CI:             ci:"
  echo "  - Cmake:          cmake:"
  echo "  - Administrative: admin:, administrative:"
  # ... (similar output for other patterns in the list)
  echo "  - --------------------------------------------\n"

  echo "Please use one of the patterns above in the commit message header."
  echo "You can also add a scope in parentheses after the pattern (e.g. 'feat(scope): ...')."
  exit 1
fi

# Matched a pattern, check for skip flag (optional)
if [[ ${skip+unset} ]]; then # Check if skip variable is set
  if [[ "$lowercase_message" =~ $skip ]]; then
    echo "Skipping commit '$message' (marked for skipping)"
    exit 0 # Allow skipping with exit code 0 for a clean commit process
  fi
fi

# Check for duplicate Signed-off-by lines (optional)
test "" = "$(grep '^Signed-off-by: ' "$1" | sort | uniq -c | sed -e '/^[ 	]*1[ 	]/d')" || {
  echo >&2 "Error: Duplicate Signed-off-by lines found in commit message!"
  exit 1
}

# Commit passed checks (optional)
echo "Commit message '$message' ($group) looks good!"

# Script exits successfully (no need for explicit exit code)
